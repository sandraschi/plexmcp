name: Build MCPB Package

on:
  # Build on version tags (e.g., v1.0.0, v2.0.0)
  push:
    tags:
      - 'v*'

  # Manual build trigger
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version (optional, defaults to run number)'
        required: false
        type: string

  # Build on main branch pushes (for testing)
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'manifest.json'
      - 'mcpb.json'
      - 'requirements.txt'
      - 'pyproject.toml'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Cache npm dependencies
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-npm-

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install MCPB CLI
      run: npm install -g @anthropic-ai/mcpb

    - name: Verify MCPB installation
      run: mcpb --version

    - name: Validate manifest
      run: mcpb validate manifest.json

    - name: Determine version
      id: version
      run: |
        if [[ "${{ github.event.inputs.version }}" != "" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        elif [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="dev-${GITHUB_RUN_NUMBER}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"

    - name: Update version in manifest.json
      if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
      run: |
        sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"${{ steps.version.outputs.version }}\"/" manifest.json

    - name: Update version in mcpb.json
      if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
      run: |
        sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"${{ steps.version.outputs.version }}\"/" mcpb.json

    - name: Create dist directory
      run: mkdir -p dist

    - name: Build MCPB package
      run: mcpb pack --config mcpb.json --output dist/plex-mcp.mcpb --no-sign

    - name: Verify package
      run: |
        ls -la dist/
        PACKAGE_SIZE=$(stat -c%s "dist/plex-mcp.mcpb")
        PACKAGE_SIZE_MB=$((PACKAGE_SIZE / 1024 / 1024))
        echo "Package size: $PACKAGE_SIZE_MB MB"
        if [ $PACKAGE_SIZE_MB -gt 5 ]; then
          echo "Warning: Package size is large (>5MB)"
        fi

    - name: Upload MCPB artifact
      uses: actions/upload-artifact@v3
      with:
        name: plex-mcp-mcpb-${{ steps.version.outputs.version }}
        path: dist/plex-mcp.mcpb
        retention-days: 90

    - name: Build Python distribution
      if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
      run: |
        pip install build
        python -m build

    - name: Upload Python artifacts
      if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v3
      with:
        name: python-distributions-${{ steps.version.outputs.version }}
        path: |
          dist/*.whl
          dist/*.tar.gz
        retention-days: 90

    - name: Publish to PyPI
      if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        pip install twine
        twine upload dist/*.whl dist/*.tar.gz

    - name: Create GitHub Release
      if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/plex-mcp.mcpb
          dist/*.whl
          dist/*.tar.gz
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
